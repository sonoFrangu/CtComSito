<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CT Communication — Varese</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body class="text-white bg-neutral-950">
    <div class="bg-animated" aria-hidden="true">
      <div class="blob blob--blue"></div>
      <div class="blob blob--violet"></div>
      <div class="blob blob--green"></div>
    </div>
    <div id="header"></div>

    <section class="pt-32 section">
      <div class="container grid items-start gap-8 md:grid-cols-2">
        <div data-aos="fade-up">
          <h1 class="text-4xl font-extrabold leading-tight md:text-5xl">Varese</h1>
          <p class="mt-3 text-neutral-300">Rivenditore multi-operatore e centro assistenza.</p>
          <div class="flex flex-wrap gap-3 mt-6">
            <a href="#servizi" class="btn-primary">Servizi</a>
            <a href="#team" class="btn-primary">Il Team</a>
            <a href="#dispositivi" class="btn-primary">Dispositivi</a>
            <a href="#recensioni" class="btn-primary">Recensioni</a>
          </div>
        </div>
        <div class="card" data-aos="fade-left">
          <h3 class="mb-2 text-lg font-semibold">Servizi in questa sede</h3>
          <ul class="space-y-2">
            <li class="flex gap-3"><span class="w-2 h-2 mt-1 bg-green-500 rounded-full"></span>Attivazioni WindTre, TIM</li>
            <li class="flex gap-3"><span class="w-2 h-2 mt-1 bg-green-500 rounded-full"></span>Fibra Fastweb (zone centrali)</li>
            <li class="flex gap-3"><span class="w-2 h-2 mt-1 bg-green-500 rounded-full"></span>Assistenza smartphone/tablet</li>
            <li class="flex gap-3"><span class="w-2 h-2 mt-1 bg-green-500 rounded-full"></span>Vendita dispositivi e accessori</li>
            <li class="flex gap-3"><span class="w-2 h-2 mt-1 bg-green-500 rounded-full"></span>UPS Access Point</li>
            <li class="flex gap-3"><span class="w-2 h-2 mt-1 bg-green-500 rounded-full"></span>Supporto resi Amazon</li>
            <li class="flex gap-3"><span class="w-2 h-2 mt-1 bg-green-500 rounded-full"></span>Preventivi luce & gas</li>
          </ul>
        </div>
      </div>
    </section>

    <section id="servizi" class="section">
      <div class="container">
        <h2 class="mb-6 text-3xl font-bold md:text-4xl" data-aos="fade-up">Cosa facciamo</h2>
        <div class="grid gap-6 md:grid-cols-3">
          <div class="card" data-aos="fade-up">
            <h3 class="mb-2 text-lg font-semibold">Telefonia & Internet</h3>
            <p class="text-neutral-300">Attivazioni WindTre, TIM. Fibra Fastweb dove disponibile.</p>
          </div>
          <div class="card" data-aos="fade-up" data-aos-delay="100">
            <h3 class="mb-2 text-lg font-semibold">Assistenza tecnica</h3>
            <p class="text-neutral-300">Riparazioni smartphone e tablet, backup dati.</p>
          </div>
          <div class="card" data-aos="fade-up" data-aos-delay="200">
            <h3 class="mb-2 text-lg font-semibold">Spedizioni & Resi</h3>
            <p class="text-neutral-300">UPS Access Point e supporto resi Amazon.</p>
          </div>
        </div>
      </div>
    </section>

    <section id="operatori" class="section">
      <div class="container">
        <h2 class="mb-6 text-3xl font-bold md:text-4xl" data-aos="fade-up">Operatori e servizi</h2>
        <div data-aos="fade-left" class="overflow-x-auto">
          <table class="w-full text-center border-separate table-fixed border-spacing-3">
            <colgroup>
              <col class="w-1/3" />
              <col class="w-1/3" />
              <col class="w-1/3" />
            </colgroup>
            <tbody class="text-white">
              <tr>
                <td class="align-middle h-28 card">
                  <img src="/loghi/windtre.svg" alt="WindTre" class="w-16 h-16 mx-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                  <span style="display:none;">WindTre</span>
                </td>
                <td class="align-middle h-28 card">
                  <img src="/loghi/fastweb.svg" alt="Fastweb" class="w-16 h-16 mx-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                  <span style="display:none;">Fastweb</span>
                </td>
                <td class="align-middle h-28 card">
                  <img src="/loghi/eolo.svg" alt="Eolo" class="w-16 h-16 mx-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                  <span style="display:none;">Eolo</span>
                </td>
              </tr>
              <tr>
                <td class="align-middle h-28 card">
                  <img src="/loghi/linkem.svg" alt="Linkem" class="w-16 h-16 mx-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                  <span style="display:none;">Linkem</span>
                </td>
                <td class="align-middle h-28 card">
                  <img src="/loghi/tim.svg" alt="TIM" class="w-16 h-16 mx-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                  <span style="display:none;">TIM</span>
                </td>
                <td class="align-middle h-28 card">
                  <img src="/loghi/verymobile.svg" alt="Very Mobile" class="w-16 h-16 mx-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                  <span style="display:none;">Very Mobile</span>
                </td>
              </tr>
              <tr>
                <td class="align-middle h-28 card" colspan="1">
                  <img src="/loghi/skywifi.svg" alt="Sky Wifi" class="w-16 h-16 mx-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                  <span style="display:none;">Sky Wifi</span>
                </td>
                <td class="align-middle h-28 card" colspan="1">
                  <img src="/loghi/dhl.svg" alt="DHL ServicePoint" class="w-16 h-16 mx-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                  <span style="display:none;">DHL Service Point</span>
                </td>
                <td class="align-middle h-28 card card--highlight-energy" colspan="1">
                  <img src="/loghi/lucegas.svg" alt="Luce &amp; Gas" class="w-20 h-20 mx-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                  <span style="display:none;">Luce &amp; Gas</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="team" class="section">
      <div class="container">
        <h2 class="mb-6 text-3xl font-bold md:text-4xl" data-aos="fade-up">I nostri dipendenti</h2>
        <div id="team-grid" class="grid gap-6 sm:grid-cols-2 md:grid-cols-3"></div>
      </div>
    </section>

    <section id="galleria" class="section">
      <div class="container">
        <h2 class="mb-6 text-3xl font-bold md:text-4xl" data-aos="fade-up">Galleria negozio</h2>
        <p class="text-sm text-neutral-300" data-aos="fade-up" data-aos-delay="50">
          Foto caricate dal pannello di gestione.
        </p>
        <div id="sede-gallery" class="grid gap-4 mt-4 sm:grid-cols-2 md:grid-cols-3"></div>
      </div>
    </section>

    <section id="dispositivi" class="section">
      <div class="container grid items-start gap-8 md:grid-cols-2">
        <div data-aos="fade-up">
          <h2 class="text-3xl font-bold md:text-4xl">Scopri i nostri dispositivi</h2>
          <p class="mt-2 text-neutral-300">Seleziona un dispositivo dalla galleria a destra per leggere descrizione e prezzo (quando disponibile).</p>
          <div class="mt-6 card">
            <h3 id="dev-name" class="text-2xl font-extrabold">&nbsp;</h3>
            <p id="dev-desc" class="mt-2 text-neutral-300">&nbsp;</p>
            <p id="dev-price" class="mt-3 text-lg font-semibold text-green-400"></p>
            <div class="flex gap-3 mt-4">
              <a href="#contatti" class="btn-primary">Chiedi disponibilità</a>
            </div>
          </div>
        </div>
        <div data-aos="fade-left">
          <div class="relative">
            <div id="dev-carousel" class="flex gap-3 pb-2 overflow-x-auto snap-x snap-mandatory"></div>
            <div class="flex items-center justify-between mt-3">
              <button id="dev-prev" class="btn-primary" type="button">◀</button>
              <button id="dev-next" class="btn-primary" type="button">▶</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="recensioni" class="section">
      <div class="container text-center">
        <h2 class="mb-6 text-3xl font-bold md:text-4xl" data-aos="fade-up">Recensioni Google</h2>
        <p class="mb-6 text-neutral-300" data-aos="fade-up" data-aos-delay="100">Leggi cosa dicono i nostri clienti su Varese.</p>
        <a href="https://www.google.com/search?q=viale+borri+162+varese&num=10&client=safari&sca_esv=3d3edac27adaa913&rls=en&hl=it-IT&biw=1710&bih=1073&tbm=lcl&sxsrf=AE3TifPBKm2JwteSmyYGurmOjd40T8ytMQ%3A1762945034883&ei=CmgUaYjbNZO5wN4P2LOiyQs&oq=viale+borri+162&gs_lp=Eg1nd3Mtd2l6LWxvY2FsIg92aWFsZSBib3JyaSAxNjIqAggAMgUQABiABDICECYyAhAmMgYQABgWGB4yAhAmMgIQJjICECYyCBAAGIAEGKIEMggQABiABBiiBDIIEAAYgAQYogRIj0hQmRFY2jZwAXgAkAEAmAGvAaAB1AyqAQQxMC42uAEByAEA-AEBmAIQoAKKDqgCAMICBRAhGKABwgILEAAYgAQYsQMYgwHCAg4QABiABBixAxiDARiKBcICCBAAGIAEGLEDwgIKEAAYgAQYQxiKBcICDRAAGIAEGEMYyQMYigXCAg4QABiABBiSAxi4BBiKBcICCxAAGIAEGJIDGIoFwgINEAAYgAQYsQMYQxiKBcICBBAAGAOYAwfxBZQwOvjob49yiAYBkgcFNy44LjGgB4tbsgcFNy44LjG4B4oOwgcIMi0xMS40LjHIB30&sclient=gws-wiz-local#" target="_blank" rel="noopener" class="btn-primary" data-aos="zoom-in">Apri le recensioni</a>
      </div>
    </section>

    <section class="section" id="contatti">
      <div class="container">
        <div class="grid gap-6 md:grid-cols-1">
          <div class="card" data-aos="fade-up">
            <h3 class="text-lg font-semibold">Varese</h3>
            <p class="mt-1 text-neutral-300">Viale Luigi Borri, 162</p>
            <p class="mt-3">Telefono: <a class="text-green-400 hover:underline" href="tel:+393882552292">388 255 2292</a></p>
            <p class="mt-1">WhatsApp: <a class="text-green-400 hover:underline" href="https://wa.me/393882552292" target="_blank" rel="noopener">Chatta ora</a></p>
            <div class="mt-4 overflow-hidden border rounded-lg border-white/10">
              <iframe title="Mappa Varese" src="https://www.google.com/maps?q=Viale+Luigi+Borri,+162,+Varese&output=embed" width="100%" height="220" style="border:0;" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div id="footer"></div>

    <script type="module">
      import "./main.js";
      import { renderHeader, renderFooter, renderTeam, enablePageTransitions } from "./components.js";

      import { createClient } from "@supabase/supabase-js";

      const supabaseUrl = "https://bvdsyogzgkgjkwnnycyr.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2ZHN5b2d6Z2tnamt3bm55Y3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMTE5OTYsImV4cCI6MjA3ODU4Nzk5Nn0.6Iw2r8hXg6VN-kmw4NoOTSGRzMH20SP2PhbTq1o3G-0";
      const supabase = createClient(supabaseUrl, supabaseKey);
      const SEDE = "varese";

      // Prevent automatic scroll restoration and ensure page opens at the top
      if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual";
      }
      // On page show (including bfcache restores), keep top unless a hash is present
      window.addEventListener("pageshow", () => {
        if (!location.hash) {
          window.scrollTo(0, 0);
        }
      });
      document.getElementById("header").innerHTML = renderHeader("varese");
      document.getElementById("footer").innerHTML = renderFooter();
      renderTeam("team-grid");

      // === Devices data (Varese) da Supabase ===
      let devices = [];
      let current = 0;

      const nameEl = document.getElementById("dev-name");
      const descEl = document.getElementById("dev-desc");
      const priceEl = document.getElementById("dev-price");
      const wrap = document.getElementById("dev-carousel");
      const prevBtn = document.getElementById("dev-prev");
      const nextBtn = document.getElementById("dev-next");

      function renderSlidesForDevice(d) {
        if (!wrap) return;
        if (!d || !Array.isArray(d.images) || !d.images.length) {
          wrap.innerHTML = '<p class="p-4 text-sm text-neutral-400">immagine mancante</p>';
          return;
        }
        wrap.innerHTML = d.images
          .map((src, idx) => {
            const safeImg = src
              ? `<img src="${src}" alt="${d.name || ''}" class="object-cover w-full h-full" onerror="this.replaceWith(Object.assign(document.createElement('div'),{textContent:'immagine mancante',className:'p-4 text-sm text-neutral-400'}))"/>`
              : '<div class="flex items-center justify-center w-full h-full p-4 text-sm text-neutral-500">immagine mancante</div>';
            return `
              <div data-img-idx="${idx}" class="snap-center shrink-0 card overflow-hidden w-[260px] h-[180px]">
                ${safeImg}
              </div>
            `;
          })
          .join("");
      }

      function show(idx, { scroll = false } = {}) {
        if (!devices.length) {
          nameEl.textContent = "Nessun dispositivo disponibile";
          descEl.textContent = "";
          priceEl.textContent = "";
          if (wrap) {
            wrap.innerHTML = '<p class="p-4 text-sm text-neutral-400">Nessun dispositivo registrato per questa sede.</p>';
          }
          return;
        }
        current = (idx + devices.length) % devices.length;
        const d = devices[current];
        nameEl.textContent = d.name;
        descEl.textContent = d.descr || d.desc || "";
        priceEl.textContent = d.price
          ? (typeof d.price === "number" ? `€${d.price.toFixed(2)}` : d.price)
          : "";

        renderSlidesForDevice(d);

        if (scroll && wrap) {
          const first = wrap.querySelector("[data-img-idx='0']");
          if (first) first.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
        }
      }

      const galleryContainer = document.getElementById("sede-gallery");

      async function loadGallery() {
        if (!galleryContainer) return;
        const { data, error } = await supabase
          .from("gallery")
          .select("id,path,created_at")
          .eq("sede", SEDE)
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Errore gallery Varese", error);
          galleryContainer.innerHTML = '<p class="text-sm text-red-400">Errore nel caricamento della galleria.</p>';
          return;
        }

        if (!data || !data.length) {
          galleryContainer.innerHTML = '<p class="text-sm text-neutral-400">Nessuna foto caricata per questa sede.</p>';
          return;
        }

        const bucket = `${SEDE}-gallery`;

        galleryContainer.innerHTML = data
          .map((r) => {
            const { data: pub } = supabase.storage.from(bucket).getPublicUrl(r.path);
            const url = (pub && pub.publicUrl) || "";
            return `
              <div class="overflow-hidden card" data-aos="fade-up">
                <img src="${url}" alt="Negozio Varese" class="object-cover w-full h-48" />
              </div>
            `;
          })
          .join("");
      }

      async function loadDevices() {
        const { data, error } = await supabase
          .from("devices")
          .select("id,name,descr,price,images,sede,created_at")
          .eq("sede", SEDE)
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Errore devices Varese", error);
          devices = [];
          show(0);
          return;
        }

        devices = data || [];
        show(0);
      }

      prevBtn.addEventListener("click", () => show(current - 1, { scroll: true }));
      nextBtn.addEventListener("click", () => show(current + 1, { scroll: true }));

      // === Slow smooth scroll for in-page anchors ===
      function smoothScrollTo(targetY, duration = 1100) {
        const startY = window.scrollY || window.pageYOffset;
        const delta = targetY - startY;
        const start = performance.now();
        const ease = (t) => (t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2);
        function step(now) {
          const p = Math.min(1, (now - start) / duration);
          window.scrollTo(0, startY + delta * ease(p));
          if (p < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }

      document.addEventListener("click", (e) => {
        const a = e.target.closest('a[href^="#"]');
        if (!a) return;
        const id = a.getAttribute("href").slice(1);
        if (!id) return;
        const el = document.getElementById(id);
        if (!el) return;
        e.preventDefault();
        const y = el.getBoundingClientRect().top + window.scrollY - 80; // compensate sticky header
        smoothScrollTo(y, 1200); // slower scroll
      });

      (async () => {
        await loadGallery();
        await loadDevices();
      })();

      enablePageTransitions();
    </script>
  </body>
</html>